<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance list</title>
    <link rel="stylesheet" href="../css/lists.css">
</head>
<body>

<div class="container">
    <label for="group">Select Group:</label>
    <select id="group" name="group">
        <!-- Опции групп будут добавлены динамически при загрузке страницы -->
    </select>

    <h2>Attendance List</h2>
    <button onclick="requestAttendanceList()">View List</button>
    <table id="attendanceTable">
        <thead>
            <tr id="tableHeader">
                <!-- Table headers will be dynamically added using JavaScript -->
            </tr>
        </thead>
        <tbody>
            <!-- Table content will be dynamically added using JavaScript -->
        </tbody>
    </table>

</div>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>

    function fillGroupOptions(groups) {
        var select = $('#group');

        $.each(groups, function(index, group) {
            select.append($('<option>', {
                value: group.group_id,
                text: group.name
            }));
        });
    }

    $.ajax({
        url: '../api/index.php',
        type: 'GET',
        dataType: 'json',
        headers: {
            'X-Request-URI': '/api/groups',
            'Authorization': localStorage.getItem('jwtToken'),
        }
    }).done(function(groups) {
        console.log(groups);
        fillGroupOptions(groups);
        if (groups.error === "Unauthorized"){
            // Переход на другую страницу
            window.location.href = 'authentification.html';
        }
    })
    .fail(function(jqXHR, textStatus, errorThrown) {
        console.error('Error:', textStatus, errorThrown);
        console.error('Response:', jqXHR.responseText);
    });

    function populateTable(table_name, data) {
        var table = document.getElementById(table_name);

        // Проверка наличия кнопки
        var buttons = document.querySelectorAll('button');
        var editButton;
        console.log(buttons);

        buttons.forEach(function (button) {
            if (button.textContent === 'Edit' ||  button.textContent === 'Save') {
                editButton = button;
                editButton.remove();
            }
        });

        editButton = document.createElement("button");
        editButton.textContent = "Edit";
        editButton.addEventListener("click", function () {
            EditSwitch();
        });
        table.parentNode.appendChild(editButton);

        table.innerHTML = '<thead><tr id="tableHeader"></tr></thead><tbody></tbody>';
        var tableHeader = table.querySelector('tr');

        Object.keys(data.list[0]).forEach(function (key) {
            if (key !== 'schedule_id' && key !== 'student_id')
            {
            var th = document.createElement("th");
            th.textContent = key.replace(/_/g, ' ').toUpperCase();
            tableHeader.appendChild(th);
            }
        });

        var tableBody = table.querySelector('tbody');
        var editMode = false; // флаг для отслеживания режима редактирования

        data.list.forEach(function (entry) {
            var row = tableBody.insertRow();
            Object.keys(entry).forEach(function (key) {
                if (key !== 'schedule_id' && key !== 'student_id')
                {
                    var cell = row.insertCell();
                    cell.textContent = entry[key];
                }
            });
        });

        function EditSwitch() {
            if (editMode) {
                saveChanges(data.list);
                editButton.textContent = "Edit";
            } else {
                editButton.textContent = "Save";
            }
            editMode = !editMode;
            updateEditMode();

        }

        function updateEditMode() {
            var rowCount = table.rows.length;
            var colCount = table.rows[0].cells.length;
            for(var i = 1; i < rowCount; i++)
            {
                for(var j = 0; j < colCount; j++)
                {
                    var cell = table.rows[i].cells[j];
                    if (j == 5) 
                    {
                        cell.setAttribute("contenteditable", editMode);
                    }
                }
            }
        }

        function saveChanges(dataList) {
            // Сбор измененных данных и отправка на сервер
            var editedData = [];

            console.log(table);
            dataList.forEach(function (entry, rowIndex) {
                if (entry.schedule_id !== undefined) {
                    var gradeCell = table.rows[rowIndex + 1].cells[5];
                    if (gradeCell) {
                        var editedEntry = {
                            schedule_id: entry.schedule_id,
                            student_id: entry.student_id,
                            grade: gradeCell.textContent || ""
                        };
                        editedData.push(editedEntry);
                    }
                }
            });

            console.log(editedData);

            // Отправка данных на сервер (вам нужно адаптировать эту часть)
            $.ajax({
                url: '../api/index.php',
                type: 'POST',
                dataType: 'json',
                headers: {
                    'X-Request-URI': '/api/set_grades_list',
                    'Authorization': localStorage.getItem('jwtToken'),
                },
                data: JSON.stringify(editedData)
            }).done(function(data) {
                console.log('Changes saved successfully:', data);
            })
            .fail(function(jqXHR, textStatus, errorThrown) {
                console.error('Error:', textStatus, errorThrown);
                console.error('Response:', jqXHR.responseText);
            });
        }
    }

    function requestAttendanceList() {
        var group = $('#group').val();
        console.log(group);

        $.ajax({
            url: '../api/index.php',
            type: 'POST',
            dataType: 'json',
            headers: {
                'X-Request-URI': '/api/view_attendance_list',
                'Authorization': localStorage.getItem('jwtToken'),
            },
            data: JSON.stringify({ group_id: group }),
        }).done(function(data) {
            console.log(data);
            if (data.list.length > 0) {
                populateTable("attendanceTable", data);
            } else {
                showNoDataMessage("attendanceTable");
            }
        })
        .fail(function(jqXHR, textStatus, errorThrown) {
            console.error('Error:', textStatus, errorThrown);
            console.error('Response:', jqXHR.responseText);
        });
    }

    function showNoDataMessage(table_name) {
        var table = document.getElementById(table_name);
        table.innerHTML = '<thead><tr><th>No Data Available</th></tr></thead><tbody></tbody>';
    }
</script>
</body>
</html>
